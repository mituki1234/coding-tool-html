<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>コードエディター with プレビュー</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .editor-container {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .file-tabs {
            display: flex;
            gap: 5px;
        }

        .file-tab {
            padding: 8px 15px;
            background-color: #f0f0f0;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            border: 1px solid #ddd;
            border-bottom: none;
        }

        .file-tab.active {
            background-color: #fff;
            border-bottom: 2px solid #4285f4;
        }

        .editor-buttons {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 15px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #3367d6;
        }

        button.secondary {
            background-color: #f1f1f1;
            color: #333;
        }

        button.secondary:hover {
            background-color: #e0e0e0;
        }

        textarea {
            width: 100%;
            height: 300px;
            padding: 15px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.5;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            tab-size: 4;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .preview-popup {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 80%;
            height: 80%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .popup-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-popup {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #333;
        }

        #preview-frame {
            flex: 1;
            border: none;
            width: 100%;
        }

        .file-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .file-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .file-input button {
            white-space: nowrap;
        }

        .hidden {
            display: none;
        }

        .file-manager {
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }

        .file-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-actions {
            display: flex;
            gap: 5px;
        }

        .file-actions button {
            padding: 2px 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>コードエディター with プレビュー</h1>
        
        <div class="editor-container">
            <div class="editor-header">
                <div class="file-tabs">
                    <div class="file-tab active" data-file="html">HTML</div>
                    <div class="file-tab" data-file="css">CSS</div>
                    <div class="file-tab" data-file="js">JavaScript</div>
                </div>
                
                <div class="editor-buttons">
                    <button id="add-file-btn">ファイル追加</button>
                    <button id="preview-btn">プレビュー表示</button>
                </div>
            </div>
            
            <div class="file-input hidden">
                <input type="text" id="file-path" placeholder="ファイルパス (例: styles/main.css)">
                <select id="file-type">
                    <option value="css">CSS</option>
                    <option value="js">JavaScript</option>
                </select>
                <button id="save-file-btn">保存</button>
                <button id="cancel-file-btn" class="secondary">キャンセル</button>
            </div>
            
            <textarea id="html-editor" placeholder="HTMLを入力してください"></textarea>
            <textarea id="css-editor" class="hidden" placeholder="CSSを入力してください"></textarea>
            <textarea id="js-editor" class="hidden" placeholder="JavaScriptを入力してください"></textarea>
            
            <div class="file-manager">
                <h3>関連ファイル</h3>
                <div class="file-list" id="file-list">
                    <!-- ファイルリストがここに表示されます -->
                </div>
            </div>
        </div>
    </div>

    <div class="popup-overlay" id="popup-overlay">
        <div class="preview-popup">
            <div class="popup-header">
                <h2>プレビュー</h2>
                <button class="close-popup" id="close-popup">&times;</button>
            </div>
            <iframe id="preview-frame"></iframe>
        </div>
    </div>

    <script>
        // ファイル管理
        const files = {
            'index.html': '',
            'style.css': '',
            'script.js': ''
        };
        
        const customFiles = {};
        
        // DOM要素
        const htmlEditor = document.getElementById('html-editor');
        const cssEditor = document.getElementById('css-editor');
        const jsEditor = document.getElementById('js-editor');
        const fileTabs = document.querySelectorAll('.file-tab');
        const previewBtn = document.getElementById('preview-btn');
        const popupOverlay = document.getElementById('popup-overlay');
        const closePopupBtn = document.getElementById('close-popup');
        const previewFrame = document.getElementById('preview-frame');
        const addFileBtn = document.getElementById('add-file-btn');
        const fileInput = document.querySelector('.file-input');
        const filePathInput = document.getElementById('file-path');
        const fileTypeSelect = document.getElementById('file-type');
        const saveFileBtn = document.getElementById('save-file-btn');
        const cancelFileBtn = document.getElementById('cancel-file-btn');
        const fileList = document.getElementById('file-list');
        
        // 初期設定
        htmlEditor.value = '<!DOCTYPE html>\n<html>\n<head>\n  <title>マイページ</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <h1>こんにちは、世界！</h1>\n  \n  <script src="script.js"><\/script>\n</body>\n</html>';
        cssEditor.value = 'body {\n  font-family: Arial, sans-serif;\n  margin: 20px;\n  background-color: #f0f0f0;\n}\n\nh1 {\n  color: #333;\n  text-align: center;\n}';
        jsEditor.value = 'document.addEventListener("DOMContentLoaded", function() {\n  console.log("ページが読み込まれました！");\n});';
        
        files['index.html'] = htmlEditor.value;
        files['style.css'] = cssEditor.value;
        files['script.js'] = jsEditor.value;
        
        // ファイルタブの切り替え
        fileTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const fileType = tab.getAttribute('data-file');
                
                // アクティブなタブを切り替え
                fileTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // エディターを切り替え
                htmlEditor.classList.add('hidden');
                cssEditor.classList.add('hidden');
                jsEditor.classList.add('hidden');
                
                if (fileType === 'html') {
                    htmlEditor.classList.remove('hidden');
                } else if (fileType === 'css') {
                    cssEditor.classList.remove('hidden');
                } else if (fileType === 'js') {
                    jsEditor.classList.remove('hidden');
                }
            });
        });
        
        // ファイルの自動保存
        htmlEditor.addEventListener('input', () => {
            files['index.html'] = htmlEditor.value;
        });
        
        cssEditor.addEventListener('input', () => {
            files['style.css'] = cssEditor.value;
        });
        
        jsEditor.addEventListener('input', () => {
            files['script.js'] = jsEditor.value;
        });
        
        // ファイル追加UI表示
        addFileBtn.addEventListener('click', () => {
            fileInput.classList.toggle('hidden');
        });
        
        // ファイル追加キャンセル
        cancelFileBtn.addEventListener('click', () => {
            fileInput.classList.add('hidden');
            filePathInput.value = '';
        });
        
        // 新しいファイルを追加
        saveFileBtn.addEventListener('click', () => {
            const filePath = filePathInput.value.trim();
            const fileType = fileTypeSelect.value;
            
            if (filePath) {
                // 拡張子をチェック
                let extension = filePath.split('.').pop().toLowerCase();
                if (fileType === 'css' && extension !== 'css') {
                    alert('CSSファイルの拡張子は.cssである必要があります');
                    return;
                } else if (fileType === 'js' && extension !== 'js') {
                    alert('JavaScriptファイルの拡張子は.jsである必要があります');
                    return;
                }
                
                // 既存ファイルをチェック
                if (files[filePath] || customFiles[filePath]) {
                    alert('このファイルは既に存在します');
                    return;
                }
                
                // 新しいファイルを追加
                customFiles[filePath] = '';
                updateFileList();
                
                fileInput.classList.add('hidden');
                filePathInput.value = '';
            } else {
                alert('有効なファイルパスを入力してください');
            }
        });
        
        // ファイルリストの更新
        function updateFileList() {
            fileList.innerHTML = '';
            
            // メインファイル
            const mainFileHTML = `
                <div class="file-item">
                    <span>index.html (HTML)</span>
                </div>
                <div class="file-item">
                    <span>style.css (CSS)</span>
                </div>
                <div class="file-item">
                    <span>script.js (JavaScript)</span>
                </div>
            `;
            fileList.innerHTML = mainFileHTML;
            
            // カスタムファイル
            Object.keys(customFiles).forEach(filePath => {
                const fileType = filePath.split('.').pop().toLowerCase();
                const fileTypeLabel = fileType === 'css' ? 'CSS' : fileType === 'js' ? 'JavaScript' : 'その他';
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span>${filePath} (${fileTypeLabel})</span>
                    <div class="file-actions">
                        <button class="edit-file" data-path="${filePath}">編集</button>
                        <button class="delete-file" data-path="${filePath}">削除</button>
                    </div>
                `;
                fileList.appendChild(fileItem);
            });
            
            // ファイル編集/削除イベントリスナー
            document.querySelectorAll('.edit-file').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filePath = e.target.getAttribute('data-path');
                    editCustomFile(filePath);
                });
            });
            
            document.querySelectorAll('.delete-file').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filePath = e.target.getAttribute('data-path');
                    deleteCustomFile(filePath);
                });
            });
        }
        
        // カスタムファイルの編集
        function editCustomFile(filePath) {
            const fileType = filePath.split('.').pop().toLowerCase();
            let editor;
            
            if (fileType === 'css') {
                editor = cssEditor;
                fileTabs[1].click(); // CSSタブを選択
            } else if (fileType === 'js') {
                editor = jsEditor;
                fileTabs[2].click(); // JSタブを選択
            } else {
                alert('このファイルタイプは編集できません');
                return;
            }
            
            // 現在の内容を保存
            if (fileType === 'css') {
                files['style.css'] = cssEditor.value;
            } else if (fileType === 'js') {
                files['script.js'] = jsEditor.value;
            }
            
            // エディターにファイルの内容をロード
            editor.value = customFiles[filePath] || '';
            
            // エディターの変更を監視して現在編集中のファイルに保存
            const inputHandler = () => {
                customFiles[filePath] = editor.value;
            };
            
            // 古いイベントリスナーを削除
            editor.removeEventListener('input', inputHandler);
            
            // 新しいイベントリスナーを追加
            editor.addEventListener('input', inputHandler);
            
               // 現在編集中のファイルを表示
               const activeEditor = document.querySelector('.file-tab.active').getAttribute('data-file');
               alert("現在 " + filePath + " を編集中です");
        }
        
        // カスタムファイルの削除
        function deleteCustomFile(filePath) {
            if (confirm(`${filePath} を削除してもよろしいですか？`)) {
                delete customFiles[filePath];
                updateFileList();
            }
        }
        
        // 初期ファイルリストの更新
        updateFileList();
        
        // プレビュー表示
        previewBtn.addEventListener('click', () => {
            // エディターの内容を更新
            files['index.html'] = htmlEditor.value;
            files['style.css'] = cssEditor.value;
            files['script.js'] = jsEditor.value;
            
            // プレビューを生成して表示
            generatePreview();
            popupOverlay.style.display = 'flex';
        });
        
        // プレビューを閉じる
        closePopupBtn.addEventListener('click', () => {
            popupOverlay.style.display = 'none';
        });
        
        // 外側をクリックしてもプレビューを閉じられるように
        popupOverlay.addEventListener('click', (e) => {
            if (e.target === popupOverlay) {
                popupOverlay.style.display = 'none';
            }
        });
        
        // プレビューの生成
        function generatePreview() {
            const iframe = document.getElementById('preview-frame');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            // iframeの内容をクリア
            iframeDoc.open();
            
            // Blobを使用してファイルURLを作成
            const htmlBlob = new Blob([files['index.html']], { type: 'text/html' });
            const cssBlob = new Blob([files['style.css']], { type: 'text/css' });
            const jsBlob = new Blob([files['script.js']], { type: 'text/javascript' });
            
            // メインファイルのURLを作成
            const htmlUrl = URL.createObjectURL(htmlBlob);
            const cssUrl = URL.createObjectURL(cssBlob);
            const jsUrl = URL.createObjectURL(jsBlob);
            
            // カスタムファイルのURLを作成
            const customFileUrls = {};
            Object.keys(customFiles).forEach(filePath => {
                const fileType = filePath.split('.').pop().toLowerCase();
                let mimeType = 'text/plain';
                
                if (fileType === 'css') {
                    mimeType = 'text/css';
                } else if (fileType === 'js') {
                    mimeType = 'text/javascript';
                } else if (fileType === 'html') {
                    mimeType = 'text/html';
                }
                
                const blob = new Blob([customFiles[filePath]], { type: mimeType });
                customFileUrls[filePath] = URL.createObjectURL(blob);
            });
            
            // カスタムファイルへの参照を置き換え
            let htmlContent = files['index.html'];
            
            // style.cssとscript.jsの参照を置き換え
            htmlContent = htmlContent.replace(/href\s*=\s*["']style\.css["']/g, `href="${cssUrl}"`);
            htmlContent = htmlContent.replace(/src\s*=\s*["']script\.js["']/g, `src="${jsUrl}"`);
            
            // カスタムファイルの参照を置き換え
            Object.keys(customFileUrls).forEach(filePath => {
                const escapedPath = filePath.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp('(href|src)\\s*=\\s*["\']' + escapedPath + '["\']', 'g');
                htmlContent = htmlContent.replace(regex, `$1="${customFileUrls[filePath]}"`);
            });
            
            // HTMLをiframeに書き込む
            iframeDoc.write(htmlContent);
            iframeDoc.close();
        }
    </script>
</body>
</html>
