<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Simple Web Code Editor</title>
  <!-- CodeMirror (via CDN) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
  <link rel="stylesheet" href="./style.css" />
  <style>
  	body {
  font-family: sans-serif;
  margin: 16px;
}

#fileList {
  margin-top: 16px;
  max-width: 300px;
  float: left;
}

#filesUl {
  list-style-type: none;
  padding-left: 0;
  border: 1px solid #ccc;
  min-height: 100px;
}

#filesUl li {
  cursor: pointer;
  padding: 4px 8px;
  border-bottom: 1px solid #eee;
}

#filesUl li:hover {
  background-color: #f0f0f0;
}

#editorWrapper {
  margin-left: 320px;
  margin-top: 16px;
}

.CodeMirror {
  border: 1px solid #ccc;
  height: 500px;
}

/* カスタムシンタックスハイライト例 (4色指定) */
.cm-tag,
.cm-keyword {
  color: red !important;
}
.cm-attribute,
.cm-property {
  color: blue !important;
}
.cm-string {
  color: yellow !important;
}
.cm-def /* functions and definitions */ {
  color: purple !important;
}
  </style>
</head>
<body>
  <h1>Simple Web Code Editor</h1>
  <div>
    <button id="openDirBtn">フォルダを開く</button>
    <button id="createFileBtn">新規ファイル作成</button>
    <button id="saveFileBtn">保存</button>
  </div>
  <div id="fileList">
    <h3>ファイル一覧:</h3>
    <ul id="filesUl"></ul>
  </div>
  <div id="editorWrapper">
    <textarea id="editor"></textarea>
  </div>

 	<script>
 		/****************************************************
 * Simple Web Code Editor
 * - Uses File System Access API for folder selection
 * - Provides basic CodeMirror editor
 * - Allows creation of new files
 * - Requires user confirmation to save (no autosave)
 ****************************************************/

let currentFileHandle = null;
let directoryHandle = null;
let editorInstance = null;

window.addEventListener('load', () => {
  // Initialize CodeMirror
  const editorTextArea = document.getElementById('editor');
  editorInstance = CodeMirror.fromTextArea(editorTextArea, {
    mode: 'htmlmixed',
    lineNumbers: true
  });

  const openDirBtn = document.getElementById('openDirBtn');
  openDirBtn.addEventListener('click', openDirectory);

  const createFileBtn = document.getElementById('createFileBtn');
  createFileBtn.addEventListener('click', createNewFile);

  const saveFileBtn = document.getElementById('saveFileBtn');
  saveFileBtn.addEventListener('click', saveCurrentFile);
});

// Open directory and read contents
async function openDirectory() {
  try {
    directoryHandle = await window.showDirectoryPicker();
    await listFiles(directoryHandle);
  } catch (err) {
    console.error('Directory access cancelled or failed:', err);
  }
}

// Recursively list files in the chosen directory
async function listFiles(dirHandle) {
  const filesUl = document.getElementById('filesUl');
  filesUl.innerHTML = '';

  for await (const [name, handle] of dirHandle.entries()) {
    if (handle.kind === 'file') {
      const li = document.createElement('li');
      li.textContent = name;
      li.addEventListener('click', () => loadFile(handle));
      filesUl.appendChild(li);
    }
    // If you wish to display subdirectories, handle them here
    // else if (handle.kind === 'directory') { ... }
  }
}

// Load file content into the editor
async function loadFile(fileHandle) {
  currentFileHandle = fileHandle;
  const fileData = await fileHandle.getFile();
  const text = await fileData.text();
  editorInstance.setValue(text);
  editorInstance.setOption('mode', getModeByFilename(fileHandle.name));
}

// Determine editor mode by file extension
function getModeByFilename(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  if (ext === 'html') return 'htmlmixed';
  if (ext === 'js') return 'javascript';
  if (ext === 'css') return 'css';
  // Fallback
  return 'plaintext';
}

// Save current file (confirmation required)
async function saveCurrentFile() {
  if (!currentFileHandle) {
    alert('読み込まれたファイルがありません。');
    return;
  }

  const confirmSave = confirm('現在のファイルを上書き保存しますか？');
  if (!confirmSave) return;

  try {
    const writable = await currentFileHandle.createWritable();
    await writable.write(editorInstance.getValue());
    await writable.close();
    alert('保存が完了しました。');
  } catch (err) {
    console.error('保存に失敗:', err);
  }
}

// Create a new file in the opened directory
async function createNewFile() {
  if (!directoryHandle) {
    alert('先にフォルダを開いてください。');
    return;
  }
  const fileName = prompt('新しいファイル名を入力してください (例: newfile.html)');
  if (!fileName) return;

  try {
    // File System Access API (origin trial)
    // In some browsers, you can create a file this way:
    const newFileHandle = await directoryHandle.getFileHandle(fileName, { create: true });
    currentFileHandle = newFileHandle;
    editorInstance.setValue('');
    editorInstance.setOption('mode', getModeByFilename(fileName));
    await listFiles(directoryHandle);
  } catch (err) {
    console.error('新規ファイル作成に失敗:', err);
  }
}
 	</script>
</body>
</html>
