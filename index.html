<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Simple Web Code Editor</title>
  <!-- CodeMirror (via CDN) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/xml/xml.min.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
  	body {
  font-family: 'Segoe UI', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 0;
  padding: 20px;
  background-color: #f5f5f5;
  color: #333;
}

h1 {
  color: #e41e3f;
  margin-bottom: 20px;
  font-weight: 400;
}

/* Button styles */
button {
  background-color: #e41e3f;
  color: white;
  border: none;
  padding: 8px 16px;
  margin-right: 10px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: background-color 0.2s;
}

button:hover {
  background-color: #c41835;
}

/* Main container */
.editor-container {
  display: flex;
  gap: 20px;
  margin-top: 20px;
}

#fileList {
  flex: 0 0 250px;
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  padding: 16px;
  height: calc(100vh - 150px);
  overflow: auto;
}

#fileList h3 {
  margin-top: 0;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
  color: #e41e3f;
}

.folder-header {
  display: flex;
  align-items: center;
  cursor: pointer;
  padding: 6px 0;
  font-weight: 500;
  color: #333;
}

.folder-header i {
  margin-right: 6px;
  color: #e41e3f;
}

.folder-contents {
  margin-left: 18px;
  border-left: 1px solid #eee;
  padding-left: 10px;
}

#filesUl {
  list-style-type: none;
  padding-left: 0;
  margin-top: 8px;
  border-radius: 6px;
  min-height: 50px;
}

#filesUl li {
  display: flex;
  align-items: center;
  cursor: pointer;
  padding: 8px 12px;
  margin-bottom: 4px;
  border-radius: 4px;
  transition: background-color 0.15s;
}

#filesUl li i {
  margin-right: 8px;
  width: 16px;
  text-align: center;
}

#filesUl li:hover {
  background-color: #f0f0f0;
}

#filesUl li.active {
  background-color: #f8e0e3;
  border-left: 3px solid #e41e3f;
  padding-left: 9px;
}

/* File extension styling */
.file-name {
  flex: 1;
}

.file-extension {
  padding: 2px 5px;
  border-radius: 3px;
  font-size: 11px;
  margin-left: 6px;
  text-transform: uppercase;
  font-weight: bold;
}

.ext-html {
  color: #e34c26;
  background-color: rgba(227, 76, 38, 0.1);
}

.ext-css {
  color: #264de4;
  background-color: rgba(38, 77, 228, 0.1);
}

.ext-js {
  color: #f7df1e;
  background-color: rgba(247, 223, 30, 0.1);
}

.ext-json {
  color: #000000;
  background-color: rgba(0, 0, 0, 0.1);
}

.ext-md {
  color: #083fa1;
  background-color: rgba(8, 63, 161, 0.1);
}

.ext-txt {
  color: #7e7e7e;
  background-color: rgba(126, 126, 126, 0.1);
}

.ext-php {
  color: #777bb3;
  background-color: rgba(119, 123, 179, 0.1);
}

.ext-py {
  color: #306998;
  background-color: rgba(48, 105, 152, 0.1);
}

#editorWrapper {
  flex: 1;
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  padding: 16px;
  height: calc(100vh - 150px);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.CodeMirror {
  border: 1px solid #eee;
  border-radius: 6px;
  height: 100% !important;
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  font-size: 14px;
  line-height: 1.5;
}

.CodeMirror-gutters {
  background-color: #f8f8f8;
  border-right: 1px solid #eee;
  border-top-left-radius: 6px;
  border-bottom-left-radius: 6px;
}

.CodeMirror-linenumber {
  color: #999;
}

/* いろはカラーによるシンタックスハイライト - 共通スタイル */
.cm-comment {
  color: #888888 !important; /* グレー: コメント */
  font-style: italic;
}

/* HTMLシンタックスハイライト - いろはカラー */
.cm-tag {
  color: #e41e3f !important; /* 赤: HTMLタグ */
}

.cm-attribute {
  color: #3366cc !important; /* 青: HTML属性 */
}

.cm-string {
  color: #ffd700 !important; /* 黄色: 文字列 */
}

.cm-bracket {
  color: #9370db !important; /* 控えめな紫: <> かっこ */
  font-weight: normal;
}

/* CSSシンタックスハイライト - いろはカラー */
.cm-qualifier {
  color: #e41e3f !important; /* 赤: CSSセレクタ */
}

.cm-builtin {
  color: #3366cc !important; /* 青: ビルトイン関数 */
}

.cm-property {
  color: #3366cc !important; /* 青: CSSプロパティ */
}

.cm-number {
  color: #ffd700 !important; /* 黄色: 数値 */
}

.cm-atom {
  color: #e41e3f !important; /* 赤: 特殊値 */
}

.cm-variable, .cm-variable-2 {
  color: #3366cc !important; /* 青: 変数 */
}

.cm-variable-3 {
  color: #9370db !important; /* 控えめな紫: 特殊変数 */
}

/* JavaScriptシンタックスハイライト - いろはカラー */
.cm-keyword {
  color: #e41e3f !important; /* 赤: キーワード */
  font-weight: 500;
}

.cm-operator {
  color: #3366cc !important; /* 青: 演算子 */
}

.cm-def {
  color: #9370db !important; /* 控えめな紫: 関数定義 */
}

.cm-punctuation {
  color: #9370db !important; /* 控えめな紫: かっこ、セミコロン等 */
}

/* 特別な構文要素 - いろはカラー */
.cm-meta {
  color: #888888 !important; /* グレー系: メタ情報 */
}

.cm-error {
  color: #ff3333 !important;
  text-decoration: underline wavy #ff3333;
}

/* 追加の構文要素 - いろはカラー */
.cm-header {
  color: #e41e3f !important; /* 赤: Markdownヘッダー */
  font-weight: bold;
}

.cm-quote {
  color: #3366cc !important; /* 青: 引用 */
  font-style: italic;
}

.cm-link {
  color: #3366cc !important; /* 青: リンク */
  text-decoration: underline;
}

.cm-negative {
  color: #e41e3f !important; /* 赤: 否定 */
}

.cm-positive {
  color: #ffd700 !important; /* 黄色: 肯定 */
}

.cm-hr {
  color: #888888 !important; /* グレー: 水平線 */
}

.cm-em {
  color: #9370db !important; /* 控えめな紫: 強調 */
  font-style: italic;
}

.cm-strong {
  color: #e41e3f !important; /* 赤: 強い強調 */
  font-weight: bold;
}

/* HTMLタグの括弧 < > */
.cm-m-xml.cm-bracket {
  color: #9370db !important; /* 控えめな紫: XMLタグの括弧 */
}

.cm-m-xml.cm-tag {
  color: #e41e3f !important; /* 赤: XMLタグ名 */
}

.cm-m-xml.cm-attribute {
  color: #3366cc !important; /* 青: XML属性 */
}

/* JavaScriptの括弧 {} () [] */
.cm-m-javascript.cm-bracket {
  color: #9370db !important; /* 控えめな紫: JavaScript括弧 */
}

/* JavaScript特殊文字 */
.cm-m-javascript.cm-string-2 {
  color: #ffd700 !important; /* 黄色: 正規表現など */
}

/* CSS括弧 {} */
.cm-m-css.cm-bracket {
  color: #9370db !important; /* 控えめな紫: CSS括弧 */
}

/* CSS単位 */
.cm-m-css.cm-unit {
  color: #ffd700 !important; /* 黄色: CSSの単位 */
}

/* エディタの色設定 - ダークモード */
.cm-s-darcula .CodeMirror-cursor {
  border-left: 1px solid #f8f8f2;
}

.cm-s-darcula .CodeMirror-selected {
  background: rgba(255, 255, 255, 0.1);
}

.cm-s-darcula .CodeMirror-line::selection,
.cm-s-darcula .CodeMirror-line > span::selection,
.cm-s-darcula .CodeMirror-line > span > span::selection {
  background: rgba(255, 255, 255, 0.1);
}

/* 現在のディレクトリのパス表示 */
.current-path {
  background-color: #f8f8f8;
  padding: 8px 12px;
  border-radius: 4px;
  margin-bottom: 12px;
  font-size: 13px;
  color: #666;
  border-left: 3px solid #e41e3f;
}

.directory-badge {
  display: inline-flex;
  align-items: center;
  background-color: #e41e3f;
  color: white;
  padding: 2px 8px;
  border-radius: 3px;
  font-size: 12px;
  margin-bottom: 10px;
}

.directory-badge i {
  margin-right: 4px;
  font-size: 11px;
}

/* ディレクトリ操作ボタン */
.directory-actions {
  display: flex;
  margin-bottom: 12px;
  gap: 8px;
}

.directory-actions button {
  font-size: 12px;
  padding: 4px 10px;
  background-color: #f0f0f0;
  color: #333;
  border: 1px solid #ddd;
}

.directory-actions button:hover {
  background-color: #e0e0e0;
}

.directory-actions button i {
  margin-right: 4px;
}

/* テーマ切り替えボタン */
.theme-switch {
  display: inline-flex;
  align-items: center;
  margin-left: 10px;
  background-color: #333;
  border-radius: 20px;
  padding: 3px 10px;
  color: white;
  font-size: 12px;
  cursor: pointer;
}

.theme-switch i {
  margin-right: 5px;
}

/* フォルダツリー表示のためのスタイル */
.tree-view {
  margin-left: 0;
  padding-left: 0;
}

.tree-item {
  list-style-type: none;
  margin-bottom: 4px;
}

.tree-dir {
  padding-left: 0;
}

.tree-dir-contents {
  padding-left: 20px;
  border-left: 1px dotted #ddd;
  margin-left: 8px;
  margin-top: 4px;
  display: none;
}

.tree-dir-open > .tree-dir-contents {
  display: block;
}

.tree-dir-header {
  cursor: pointer;
  display: flex;
  align-items: center;
  padding: 4px 8px;
  border-radius: 4px;
}

.tree-dir-header:hover {
  background-color: #f5f5f5;
}

.tree-dir-header i {
  margin-right: 8px;
  color: #e41e3f;
}

.tree-file {
  cursor: pointer;
  display: flex;
  align-items: center;
  padding: 4px 8px;
  border-radius: 4px;
}

.tree-file:hover {
  background-color: #f5f5f5;
}

.tree-file i {
  margin-right: 8px;
}

.tree-file.active {
  background-color: #f8e0e3;
  border-left: 3px solid #e41e3f;
  padding-left: 5px;
}

/* サンプルボタン */
.demo-buttons {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.demo-buttons button {
  background-color: #fff;
  color: #e41e3f;
  border: 1px solid #e41e3f;
  transition: all 0.2s;
}

.demo-buttons button:hover {
  background-color: #e41e3f;
  color: #fff;
}

/* ディレクトリ作成モーダル */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  background-color: #fff;
  margin: 15% auto;
  padding: 20px;
  border-radius: 8px;
  width: 400px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.modal-header h3 {
  margin: 0;
  color: #e41e3f;
}

.modal-close {
  font-size: 24px;
  cursor: pointer;
  color: #999;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  margin-top: 16px;
  gap: 8px;
}

.modal-form-group {
  margin-bottom: 16px;
}

.modal-form-group label {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
}

.modal-form-group input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.modal-form-group input:focus {
  border-color: #e41e3f;
  outline: none;
  box-shadow: 0 0 0 2px rgba(228, 30, 63, 0.1);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .editor-container {
    flex-direction: column;
  }
  
  #fileList, #editorWrapper {
    flex: none;
    width: 100%;
    height: auto;
  }
  
  #fileList {
    margin-bottom: 20px;
    height: 200px;
  }
  
  #editorWrapper {
    height: 500px;
  }
}
  </style>
</head>
<body>
  <h1>Simple Web Code Editor</h1>
  <div>
    <button id="openDirBtn"><i class="fas fa-folder-open"></i> フォルダを開く</button>
    <button id="createFileBtn"><i class="fas fa-file-plus"></i> 新規ファイル作成</button>
    <button id="createDirBtn"><i class="fas fa-folder-plus"></i> 新規フォルダ作成</button>
    <button id="saveFileBtn"><i class="fas fa-save"></i> 保存</button>
    <span class="theme-switch" id="themeSwitch"><i class="fas fa-moon"></i> ダークモード</span>
  </div>
  <div class="editor-container">
    <div id="fileList">
      <h3>ファイル一覧</h3>
      <div id="directoryOpened" style="display: none;">
        <div class="directory-badge">
          <i class="fas fa-folder-open"></i> <span id="currentDirName">ディレクトリ</span>
        </div>
        <div class="current-path" id="currentDirPath">
          /
        </div>
        <div class="directory-actions">
          <button id="parentDirBtn"><i class="fas fa-level-up-alt"></i> 上の階層へ</button>
        </div>
      </div>
      <ul id="treeRoot" class="tree-view"></ul>
    </div>
    <div id="editorWrapper">
      <textarea id="editor"></textarea>
    </div>
  </div>

  <!-- ディレクトリ作成モーダル -->
  <div id="createDirModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>新規フォルダの作成</h3>
        <span class="modal-close">&times;</span>
      </div>
      <div class="modal-body">
        <div class="modal-form-group">
          <label for="dirName">フォルダ名：</label>
          <input type="text" id="dirName" placeholder="新しいフォルダ名">
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelDirBtn">キャンセル</button>
        <button id="confirmDirBtn" style="background-color: #e41e3f;">作成</button>
      </div>
    </div>
  </div>

 	<script>
 		/****************************************************
 * Simple Web Code Editor
 * - Uses File System Access API for folder selection
 * - Provides basic CodeMirror editor
 * - Allows creation of new files and directories
 * - Requires user confirmation to save (no autosave)
 ****************************************************/

let currentFileHandle = null;
let directoryHandle = null;
let parentDirectoryHandle = null;
let editorInstance = null;
let currentDirPath = '/';
let isDarkMode = false;
let dirStack = []; // ディレクトリナビゲーション用のスタック

// サンプルコード - 言語ごとのデモ表示用
const sampleCodes = {
}

window.addEventListener('load', () => {
  // Initialize CodeMirror with proper line handling
  const editorTextArea = document.getElementById('editor');
  editorInstance = CodeMirror.fromTextArea(editorTextArea, {
    mode: 'htmlmixed',
    lineNumbers: true,
    lineWrapping: true,
    viewportMargin: Infinity,
    theme: 'default',
    autoCloseBrackets: true,
    matchBrackets: true,
    tabSize: 2,
    indentWithTabs: false
  });

  const openDirBtn = document.getElementById('openDirBtn');
  openDirBtn.addEventListener('click', openDirectory);

  const createFileBtn = document.getElementById('createFileBtn');
  createFileBtn.addEventListener('click', createNewFile);

  const saveFileBtn = document.getElementById('saveFileBtn');
  saveFileBtn.addEventListener('click', saveCurrentFile);
  
  // ディレクトリ作成ボタン
  const createDirBtn = document.getElementById('createDirBtn');
  createDirBtn.addEventListener('click', showCreateDirModal);
  
  // 親ディレクトリへ移動ボタン
  const parentDirBtn = document.getElementById('parentDirBtn');
  parentDirBtn.addEventListener('click', navigateToParentDirectory);
  
  // モーダル関連のイベントリスナー
  document.querySelector('.modal-close').addEventListener('click', hideCreateDirModal);
  document.getElementById('cancelDirBtn').addEventListener('click', hideCreateDirModal);
  document.getElementById('confirmDirBtn').addEventListener('click', createNewDirectory);
  
  // テーマ切り替え機能を追加
  const themeSwitch = document.getElementById('themeSwitch');
  themeSwitch.addEventListener('click', toggleTheme);
  
  // 言語切り替えのデモボタンを追加
  document.getElementById('demoHtml').addEventListener('click', () => showSampleCode('html'));
  document.getElementById('demoCss').addEventListener('click', () => showSampleCode('css'));
  document.getElementById('demoJs').addEventListener('click', () => showSampleCode('javascript'));
});

// サンプルコードを表示
function showSampleCode(language) {
  const code = sampleCodes[language];
  if (!code) return;
  
  editorInstance.setValue(code);
  editorInstance.setOption('mode', getModeByLanguage(language));
  editorInstance.refresh();
}

// 言語名からモードを取得
function getModeByLanguage(language) {
  switch (language) {
    case 'html': return 'htmlmixed';
    case 'css': return 'css';
    case 'javascript': return 'javascript';
    default: return 'text/plain';
  }
}

// テーマの切り替え
function toggleTheme() {
  isDarkMode = !isDarkMode;
  const themeSwitchElement = document.getElementById('themeSwitch');
  
  if (isDarkMode) {
    editorInstance.setOption('theme', 'darcula');
    document.body.style.backgroundColor = '#2d2d2d';
    document.querySelectorAll('h1, h3').forEach(el => el.style.color = '#e41e3f');
    themeSwitchElement.innerHTML = '<i class="fas fa-sun"></i> ライトモード';
    
    // ダークモード時のファイルリストとエディタの背景
    document.getElementById('fileList').style.backgroundColor = '#3a3a3a';
    document.getElementById('fileList').style.color = '#e0e0e0';
    document.getElementById('editorWrapper').style.backgroundColor = '#3a3a3a';
    
    // デモボタンの見た目を調整
    document.querySelectorAll('.demo-buttons button').forEach(btn => {
      btn.style.backgroundColor = '#333';
      btn.style.color = '#fff';
      btn.style.borderColor = '#555';
    });
    
    // ディレクトリアクションボタンの見た目を調整
    document.querySelectorAll('.directory-actions button').forEach(btn => {
      btn.style.backgroundColor = '#444';
      btn.style.color = '#ddd';
      btn.style.borderColor = '#555';
    });
    
    // ツリービューの見た目を調整
    document.querySelectorAll('.tree-dir-header, .tree-file').forEach(item => {
      item.addEventListener('mouseenter', () => {
        item.style.backgroundColor = '#4a4a4a';
      });
      item.addEventListener('mouseleave', () => {
        if (!item.classList.contains('active')) {
          item.style.backgroundColor = '';
        }
      });
    });
    
    // ツリーのディレクトリライン
    document.querySelectorAll('.tree-dir-contents').forEach(el => {
      el.style.borderLeftColor = '#555';
    });
  } else {
    editorInstance.setOption('theme', 'default');
    document.body.style.backgroundColor = '#f5f5f5';
    document.querySelectorAll('h1, h3').forEach(el => el.style.color = '#e41e3f');
    themeSwitchElement.innerHTML = '<i class="fas fa-moon"></i> ダークモード';
    
    // ライトモード時のファイルリストとエディタの背景
    document.getElementById('fileList').style.backgroundColor = 'white';
    document.getElementById('fileList').style.color = '#333';
    document.getElementById('editorWrapper').style.backgroundColor = 'white';
    
    // デモボタンの見た目をリセット
    document.querySelectorAll('.demo-buttons button').forEach(btn => {
      btn.style.backgroundColor = '#fff';
      btn.style.color = '#e41e3f';
      btn.style.borderColor = '#e41e3f';
    });
    
    // ディレクトリアクションボタンの見た目をリセット
    document.querySelectorAll('.directory-actions button').forEach(btn => {
      btn.style.backgroundColor = '#f0f0f0';
      btn.style.color = '#333';
      btn.style.borderColor = '#ddd';
    });
    
    // ツリービューの見た目をリセット
    document.querySelectorAll('.tree-dir-header, .tree-file').forEach(item => {
      item.addEventListener('mouseenter', () => {
        item.style.backgroundColor = '#f5f5f5';
      });
      item.addEventListener('mouseleave', () => {
        if (!item.classList.contains('active')) {
          item.style.backgroundColor = '';
        }
      });
    });
    
    // ツリーのディレクトリライン
    document.querySelectorAll('.tree-dir-contents').forEach(el => {
      el.style.borderLeftColor = '#ddd';
    });
  }
}

// Open directory and read contents
async function openDirectory() {
  try {
    directoryHandle = await window.showDirectoryPicker();
    parentDirectoryHandle = null; // 最初は親ディレクトリはなし
    dirStack = []; // スタックをリセット
    
    // ディレクトリ情報の表示
    document.getElementById('directoryOpened').style.display = 'block';
    document.getElementById('currentDirName').textContent = directoryHandle.name;
    document.getElementById('currentDirPath').textContent = '/' + directoryHandle.name;
    currentDirPath = '/' + directoryHandle.name;
    
    // ディレクトリの内容を表示
    await buildDirectoryTree(directoryHandle);
  } catch (err) {
    console.error('Directory access cancelled or failed:', err);
  }
}

// ディレクトリツリーを構築
async function buildDirectoryTree(dirHandle, parentElement = null) {
  const treeRoot = parentElement || document.getElementById('treeRoot');
  treeRoot.innerHTML = ''; // 内容をクリア
  
  // エントリを分類するための配列
  const directories = [];
  const files = [];
  
  // すべてのエントリを取得して分類
  for await (const [name, handle] of dirHandle.entries()) {
    if (handle.kind === 'directory') {
      directories.push({ name, handle });
    } else {
      files.push({ name, handle });
    }
  }
  
  // アルファベット順にソート
  directories.sort((a, b) => a.name.localeCompare(b.name));
  files.sort((a, b) => a.name.localeCompare(b.name));
  
  // ディレクトリを先に表示
  for (const { name, handle } of directories) {
    const dirItem = document.createElement('li');
    dirItem.className = 'tree-item tree-dir';
    
    const dirHeader = document.createElement('div');
    dirHeader.className = 'tree-dir-header';
    dirHeader.innerHTML = `<i class="fas fa-folder"></i> <span>${name}</span>`;
    
    const dirContents = document.createElement('ul');
    dirContents.className = 'tree-dir-contents';
    
    dirHeader.addEventListener('click', async () => {
      // フォルダアイコンの切り替え
      const icon = dirHeader.querySelector('i');
      const isOpen = icon.classList.contains('fa-folder-open');
      
      if (isOpen) {
        icon.classList.replace('fa-folder-open', 'fa-folder');
        dirItem.classList.remove('tree-dir-open');
      } else {
        icon.classList.replace('fa-folder', 'fa-folder-open');
        dirItem.classList.add('tree-dir-open');
        
        // フォルダを開いたときに中身を読み込む（遅延読み込み）
        if (dirContents.children.length === 0) {
          try {
            // 「読み込み中」の表示
            const loadingItem = document.createElement('li');
            loadingItem.textContent = '読み込み中...';
            dirContents.appendChild(loadingItem);
            
            // サブディレクトリの内容を取得
            await buildDirectoryTree(handle, dirContents);
          } catch (error) {
            console.error('フォルダ内容の読み込みに失敗:', error);
            dirContents.innerHTML = '<li style="color: red;">読み込みエラー</li>';
          }
        }
      }
    });
    
    // ダブルクリックで現在のディレクトリとして開く
    dirHeader.addEventListener('dblclick', async () => {
      // 現在のディレクトリをスタックに追加
      if (directoryHandle) {
        dirStack.push({
          handle: directoryHandle,
          name: document.getElementById('currentDirName').textContent,
          path: currentDirPath
        });
      }
      
      // 新しいディレクトリを現在のディレクトリに設定
      directoryHandle = handle;
      parentDirectoryHandle = dirHandle;
      document.getElementById('currentDirName').textContent = name;
      
      // パスを更新
      if (currentDirPath === '/') {
        currentDirPath = '/' + name;
      } else {
        currentDirPath = currentDirPath + '/' + name;
      }
      document.getElementById('currentDirPath').textContent = currentDirPath;
      
      // ディレクトリの内容を表示
      await buildDirectoryTree(directoryHandle);
    });
    
    dirItem.appendChild(dirHeader);
    dirItem.appendChild(dirContents);
    treeRoot.appendChild(dirItem);
  }
  
  // ファイルを表示
  for (const { name, handle } of files) {
    const fileItem = document.createElement('li');
    fileItem.className = 'tree-item tree-file';
    
    const fileIcon = document.createElement('i');
    fileIcon.className = getFileIcon(name);
    
    const fileName = document.createElement('span');
    fileName.innerHTML = formatFileName(name);
    
    fileItem.appendChild(fileIcon);
    fileItem.appendChild(fileName);
    
    fileItem.addEventListener('click', () => {
      // 他のファイルのアクティブ状態を解除
      document.querySelectorAll('.tree-file').forEach(f => {
        f.classList.remove('active');
      });
      
      // このファイルをアクティブに
      fileItem.classList.add('active');
      
      // ファイルを読み込む
      loadFile(handle);
    });
    
    treeRoot.appendChild(fileItem);
  }
  
  // もしエントリがない場合
  if (directories.length === 0 && files.length === 0) {
    const emptyItem = document.createElement('li');
    emptyItem.textContent = '空のフォルダ';
    emptyItem.style.color = '#999';
    emptyItem.style.fontStyle = 'italic';
    emptyItem.style.padding = '4px 8px';
    treeRoot.appendChild(emptyItem);
  }
}

// 親ディレクトリへの移動
async function navigateToParentDirectory() {
  // スタックからディレクトリを取得
  if (dirStack.length > 0) {
    const prevDir = dirStack.pop();
    directoryHandle = prevDir.handle;
    document.getElementById('currentDirName').textContent = prevDir.name;
    currentDirPath = prevDir.path;
    document.getElementById('currentDirPath').textContent = currentDirPath;
    
    // 親ディレクトリの内容を表示
    await buildDirectoryTree(directoryHandle);
  } else if (parentDirectoryHandle) {
    // スタックが空で親ディレクトリがある場合
    const currentName = directoryHandle.name;
    directoryHandle = parentDirectoryHandle;
    parentDirectoryHandle = null; // 最上位に戻る
    
    // パスを更新
    const pathParts = currentDirPath.split('/');
    pathParts.pop(); // 最後の部分（現在のフォルダ名）を削除
    currentDirPath = pathParts.join('/') || '/';
    
    document.getElementById('currentDirName').textContent = directoryHandle.name;
    document.getElementById('currentDirPath').textContent = currentDirPath;
    
    // 親ディレクトリの内容を表示
    await buildDirectoryTree(directoryHandle);
  }
}

// ディレクトリ作成モーダルを表示
function showCreateDirModal() {
  if (!directoryHandle) {
    alert('先にフォルダを開いてください。');
    return;
  }
  
  document.getElementById('dirName').value = '';
  document.getElementById('createDirModal').style.display = 'block';
}

// ディレクトリ作成モーダルを非表示
function hideCreateDirModal() {
  document.getElementById('createDirModal').style.display = 'none';
}

// 新しいディレクトリを作成
async function createNewDirectory() {
  if (!directoryHandle) {
    alert('先にフォルダを開いてください。');
    hideCreateDirModal();
    return;
  }
  
  const dirName = document.getElementById('dirName').value.trim();
  if (!dirName) {
    alert('フォルダ名を入力してください。');
    return;
  }
  
  try {
    // ディレクトリを作成
    const newDirHandle = await directoryHandle.getDirectoryHandle(dirName, { create: true });
    hideCreateDirModal();
    
    // ツリービューを更新
    await buildDirectoryTree(directoryHandle);
    
    // 成功メッセージ
    alert(`フォルダ「${dirName}」を作成しました。`);
  } catch (error) {
    console.error('ディレクトリ作成エラー:', error);
    alert(`フォルダの作成に失敗しました: ${error.message}`);
  }
}

// Load file content into the editor
async function loadFile(fileHandle) {
  currentFileHandle = fileHandle;
  try {
    const fileData = await fileHandle.getFile();
    const text = await fileData.text();
    
    // Fix: Set the value without adding extra line breaks
    editorInstance.setValue(text);
    editorInstance.setOption('mode', getModeByFilename(fileHandle.name));
    
    // Ensure proper refresh
    editorInstance.refresh();
  } catch (err) {
    console.error('ファイル読み込みに失敗:', err);
  }
}

// Determine editor mode by file extension
function getModeByFilename(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  if (ext === 'html' || ext === 'htm') return 'htmlmixed';
  if (ext === 'js') return 'javascript';
  if (ext === 'css') return 'css';
  if (ext === 'json') return 'application/json';
  if (ext === 'md') return 'markdown';
  if (ext === 'php') return 'php';
  if (ext === 'py') return 'python';
  // Fallback
  return 'text/plain';
}

// Save current file (confirmation required)
async function saveCurrentFile() {
  if (!currentFileHandle) {
    alert('読み込まれたファイルがありません。');
    return;
  }

  const confirmSave = confirm('現在のファイルを上書き保存しますか？');
  if (!confirmSave) return;

  try {
    const writable = await currentFileHandle.createWritable();
    await writable.write(editorInstance.getValue());
    await writable.close();
    alert('保存が完了しました。');
  } catch (err) {
    console.error('保存に失敗:', err);
  }
}

// Create a new file in the opened directory
async function createNewFile() {
  if (!directoryHandle) {
    alert('先にフォルダを開いてください。');
    return;
  }
  const fileName = prompt('新しいファイル名を入力してください (例: newfile.html)');
  if (!fileName) return;

  try {
    // File System Access API (origin trial)
    // In some browsers, you can create a file this way:
    const newFileHandle = await directoryHandle.getFileHandle(fileName, { create: true });
    currentFileHandle = newFileHandle;
    editorInstance.setValue('');
    editorInstance.setOption('mode', getModeByFilename(fileName));
    
    // ツリービューを更新
    await buildDirectoryTree(directoryHandle);
    
    // 作成したファイルを見つけてアクティブにする
    const fileItems = document.querySelectorAll('.tree-file');
    for (const item of fileItems) {
      if (item.textContent.includes(fileName)) {
        // 他のファイルのアクティブ状態を解除
        fileItems.forEach(f => f.classList.remove('active'));
        // このファイルをアクティブに
        item.classList.add('active');
        break;
      }
    }
  } catch (err) {
    console.error('新規ファイル作成に失敗:', err);
  }
}
 	</script>
</body>
</html>
